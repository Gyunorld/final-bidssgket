<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/user/fragments/layout}">
<head>
    <meta charset="UTF-8">
    <title>경매 입찰 등록</title>
    <link rel="stylesheet" href="/user/auction/css/auctionregist.css">

    <!--<script>
        function validateBids() {
            const minBidInput = document.getElementById('minTenderPrice');
            const maxBidInput = document.getElementById('maxTenderPrice');
            const submitBtn = document.querySelector('.submit-btn');
            const errorMessage = document.getElementById('error-message');
            const bidCount = parseInt(document.getElementById('bidCount').value);

            function validateMaxBid() {
                const minBidValue = parseFloat(minBidInput.value) || 0;
                const maxBidValue = parseFloat(maxBidInput.value) || 0;

                if (maxBidValue <= minBidValue) {
                    maxBidInput.setCustomValidity('최대 입찰가는 최소 입찰가보다 커야 합니다.');
                    errorMessage.textContent = '최대 입찰가는 최소 입찰가보다 커야 합니다.';
                } else {
                    maxBidInput.setCustomValidity('');
                    errorMessage.textContent = '';
                }
            }

            if (bidCount >= 2) {
                submitBtn.disabled = true;
                errorMessage.textContent = '최대 두 번까지 입찰할 수 있습니다.';
            } else {
                minBidInput.addEventListener('input', validateMaxBid);
                maxBidInput.addEventListener('input', validateMaxBid);

                submitBtn.addEventListener('click', function(event) {
                    if (!minBidInput.checkValidity() || !maxBidInput.checkValidity() || maxBidInput.value.trim() === "") {
                        event.preventDefault();
                        event.stopPropagation();
                        errorMessage.textContent = '유효한 입찰가를 입력하세요.';
                    } else {
                        document.getElementById('auctionForm').submit();
                    }
                });

                validateMaxBid();
            }
        }

        document.addEventListener('DOMContentLoaded', validateBids);
    </script>-->
    <script>
        function validateBids() {
            const minBidInput = document.getElementById('minTenderPrice');
            const maxBidInput = document.getElementById('maxTenderPrice');
            const submitBtn = document.querySelector('.submit-btn');
            const errorMessage = document.getElementById('error-message');

            function validateMaxBid() {
                const minBidValue = parseFloat(minBidInput.value) || 0;
                const maxBidValue = parseFloat(maxBidInput.value) || 0;

                if (maxBidValue <= minBidValue) {
                    maxBidInput.setCustomValidity('최대 입찰가는 최소 입찰가보다 커야 합니다.');
                    errorMessage.textContent = '최대 입찰가는 최소 입찰가보다 커야 합니다.';
                } else {
                    maxBidInput.setCustomValidity('');
                    errorMessage.textContent = '';
                }
            }

            minBidInput.addEventListener('input', validateMaxBid);
            maxBidInput.addEventListener('input', validateMaxBid);

            submitBtn.addEventListener('click', function(event) {
                if (!minBidInput.checkValidity() || !maxBidInput.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                } else {
                    const memberEmail = 'yunjc536147@gmail.com'; // Use actual user email from session/context
                    const productNo = 17; // Use actual product number from context

                    fetch(`/auction/count?email=${memberEmail}&productNo=${productNo}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.count >= 3) {
                                alert('입찰은 최대 2번만 가능합니다.');
                                window.location.href = '/user/product/detailAuction';
                            } else {
                                const maxBidField = document.getElementById('maxTenderPriceField');
                                maxBidField.value = maxBidInput.value;
                                document.getElementById('auctionForm').submit();
                            }
                        })
                        .catch(error => console.error('Error:', error));
                }
            });

            validateMaxBid();
        }

        document.addEventListener('DOMContentLoaded', validateBids);
    </script>
</head>
<body layout:fragment="content">
<div class="auction-form-container">
    <h1 class="form-title">경매 입찰 등록</h1>
    <div class="form-header-line"></div>
    <div class="form-content">
        <div class="image-container">
            <!--            <img src="" class="image-placeholder" alt="상품 이미지">-->
            <img th:each="images: ${product.productImages[0].productImg}" th:src="${images}" class="image-placeholder" alt="상품 이미지">
        </div>
        <div class="form-details">
            <h2 class="item-title" th:text="${product.productName}">상품글 제목</h2>
            <div class="form-group">
                <label for="bidder-name">입찰자 명</label>
                <input type="text" id="bidder-name" th:value="${member.memberNickname}" readonly>
            </div>
            <div class="form-group">
                <label for="minTenderPrice">최소 입찰가</label>
                <input type="number" id="minTenderPrice" th:attr="value=${minBid},min=${minBid}" placeholder="최소 입찰가 입력">
                <p class="hint" th:text="${minBid} + '원 이상 입찰되어야 합니다.'"></p>
            </div>
            <div class="form-group">
                <label for="maxTenderPrice">최대 입찰가</label>
                <input type="number" id="maxTenderPrice" placeholder="최대 입찰가 입력">
                <p class="hint" id="error-message" style="color: red;"></p>
            </div>
            <div class="form-actions">
                <form action="/auction/auctionregist" method="post" id="auctionForm">
                    <input type="hidden" name="minTenderPrice" id="minTenderPriceField" th:value="${minBid}" />
                    <input type="hidden" name="maxTenderPrice" id="maxTenderPriceField" />
                    <button type="button" class="btn submit-btn">입찰 등록</button>
                </form>
                <button type="button" class="btn cancel-btn">취소</button>
            </div>
            <p class="disclaimer">입찰을 선택하면, 낙찰자가 될 경우 이 상품을 구매하기로 약정하는 것입니다.</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('successMessage')) {
            alert(urlParams.get('successMessage'));
            window.location.href = '/user/product/detailAuction';
        } else if (urlParams.has('errorMessage')) {
            alert(urlParams.get('errorMessage'));
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
